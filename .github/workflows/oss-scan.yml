name: OSS Compliance Scan

on:
  workflow_dispatch:
    inputs:
      input_type:
        description: "zip â†’ give a ZIP URL â€¢ docker â†’ give an image reference"
        type: choice
        options: ["zip", "docker"]
        default: "zip"
      zip_url:
        description: "HTTP(S) URL of the ZIP (required if input_type=zip)"
        required: false
      docker_image:
        description: "Image reference, e.g. ghcr.io/org/app:tag (required if input_type=docker)"
        required: false
      run_scout:
        description: "Run Docker Scout step as well?"
        type: boolean
        default: false

jobs:
  scan:
    runs-on: ubuntu-latest
    env:
      ZIP_PATH: input.zip
      IMG_NAME: loaded-image          # temp tag when we load a tarball
    steps:

    # --------------------------------------------------
    # 1. FETCH THE INPUT
    # --------------------------------------------------
    - uses: actions/checkout@v4

    - name: â¬‡ï¸  Download ZIP (input_type = zip)
      if: ${{ github.event.inputs.input_type == 'zip' }}
      run: |
        curl -Lf "${{ github.event.inputs.zip_url }}" -o "$ZIP_PATH"
        unzip -q "$ZIP_PATH" -d extracted

    - name: ğŸ³ Pull image (input_type = docker)
      if: ${{ github.event.inputs.input_type == 'docker' }}
      run: docker pull "${{ github.event.inputs.docker_image }}"

    # --------------------------------------------------
    # 2. DETERMINE TARGET & (optionally) LOAD .tar
    # --------------------------------------------------
    - name: ğŸ“Œ Determine scan target & set outputs
      id: target
      run: |
        echo "is_image=false"            >> "$GITHUB_OUTPUT"
        echo "target_dir=$PWD/extracted" >> "$GITHUB_OUTPUT"

        # Case 1: user chose docker
        if [[ "${{ github.event.inputs.input_type }}" == "docker" ]]; then
          echo "is_image=true"                          >> "$GITHUB_OUTPUT"
          echo "target_image=${{ github.event.inputs.docker_image }}" >> "$GITHUB_OUTPUT"

        # Case 2: ZIP contains a *.tar (docker save)
        elif tarfile=$(find extracted -maxdepth 1 -name '*.tar' -print -quit); then
          docker load -i "$tarfile" | awk '{print $3}' > image_id.txt
          docker tag "$(cat image_id.txt)" "$IMG_NAME:latest"
          echo "is_image=true"            >> "$GITHUB_OUTPUT"
          echo "target_image=$IMG_NAME:latest" >> "$GITHUB_OUTPUT"
        fi

    # --------------------------------------------------
    # 3. RUN SCANNERS
    # --------------------------------------------------
    - name: ğŸ“ Install Syft
      run: curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | \
           sh -s -- -b /usr/local/bin

    - name: ğŸ“ Syft SBOM
      continue-on-error: true
      run: |
        if [[ "${{ steps.target.outputs.is_image }}" == "true" ]]; then
          syft "${{ steps.target.outputs.target_image }}" -o json > syft_output.json
        else
          syft "${{ steps.target.outputs.target_dir }}"   -o json > syft_output.json
        fi

    - name: ğŸ“ Tern SBOM (images only)
      if: ${{ steps.target.outputs.is_image == 'true' }}
      continue-on-error: true
      run: |
        sudo pip install --quiet tern
        tern report -i "${{ steps.target.outputs.target_image }}" -o tern_output.json

    - name: ğŸ“ SCANOSS file-level scan
      continue-on-error: true
      run: |
        mkdir fsroot
        if [[ "${{ steps.target.outputs.is_image }}" == "true" ]]; then
          docker create --name tmp "${{ steps.target.outputs.target_image }}"
          docker cp tmp:/ fsroot/
          docker rm  tmp
        else
          cp -r "${{ steps.target.outputs.target_dir }}/." fsroot/
        fi
        docker run --rm -v "$PWD/fsroot":/scan scanoss/scanoss-toolkit scan \
          -o scanoss_output.json /scan

    - name: ğŸ“ Docker Scout (optional)
      if: ${{ steps.target.outputs.is_image == 'true' && github.event.inputs.run_scout == 'true' }}
      continue-on-error: true
      run: docker scout quickview "${{ steps.target.outputs.target_image }}" \
           --output json > scout_output.json

    # --------------------------------------------------
    # 4. BUILD EXCEL SUMMARY
    # --------------------------------------------------
    - name: ğŸ—ƒï¸  Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    - name: ğŸ—ƒï¸  JSON â†’ Excel
      if: always()
      run: |
        python - <<'PY'
        import json, glob, pandas as pd, sys
        sheets={}
        for f in glob.glob("*_output.json"):
            try:
                data=json.load(open(f, encoding="utf-8"))
                df=pd.json_normalize(data)
                sheets[f.replace("_output.json","")] = df
            except Exception as e:
                print("âš ï¸  skipped", f, e, file=sys.stderr)
        if sheets:
            with pd.ExcelWriter("compliance_report.xlsx") as xl:
                for name,df in sheets.items():
                    df.to_excel(xl, sheet_name=name[:31], index=False)
        PY

    # --------------------------------------------------
    # 5. PUBLISH RESULTS
    # --------------------------------------------------
    - name: ğŸ“¤ Upload scan artefacts
      uses: actions/upload-artifact@v4
      with:
        name: oss-scan-results
        path: |
          syft_output.json
          tern_output.json
          scanoss_output.json
          scout_output.json
          compliance_report.xlsx
        if-no-files-found: ignore
